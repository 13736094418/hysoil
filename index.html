<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HYsoil首页</title>
    <link rel="stylesheet" href="style.css">
</head>

<body class="home-screen">

    <!-- 顶部主区域 -->
    <div class="sky-hero">
        <header class="hero-head">
            <h1 class="hero-title">欢迎进入HYsoil电池“哨兵”卫士</h1>
            <div class="hero-icons">
                <button class="icon-btn headset"></button>
                <button class="icon-btn bell"></button>
                <button class="icon-btn more"></button>
            </div>
        </header>

        <section class="hero-metrics all-metrics">
            <!-- 第 1 行：温度 / 湿度 -->
            <div class="metric-block">
                <p class="metric-label">电池腔温度</p>
                <p class="metric-value" id="battery-temp">-- °C</p>
            </div>
            <div class="metric-block">
                <p class="metric-label">电池腔湿度</p>
                <p class="metric-value" id="battery-humidity">-- %</p>
            </div>

            <!-- 第 2〜4 行：六个气体 / 压力传感器 -->
            <div class="metric-block">
                <p class="metric-label">HF传感器</p>
                <p class="metric-value" id="hf-sensor">-- ppm</p>
            </div>
            <div class="metric-block">
                <p class="metric-label">CO传感器</p>
                <p class="metric-value" id="co-sensor">-- ppm</p>
            </div>

            <div class="metric-block">
                <p class="metric-label">H₂传感器</p>
                <p class="metric-value" id="h2-sensor">-- ppm</p>
            </div>
            <div class="metric-block">
                <p class="metric-label">C₂O传感器</p>
                <p class="metric-value" id="c2o-sensor">-- ppm</p>
            </div>

            <div class="metric-block">
                <p class="metric-label">TVOC传感器</p>
                <p class="metric-value" id="tvoc-sensor">-- ppm</p>
            </div>
            <div class="metric-block">
                <p class="metric-label">压力传感器</p>
                <p class="metric-value" id="pressure-sensor">-- kPa</p>
            </div>
        </section>
        <!-- 中间 + 按钮 -->

    </div>

    <!-- 底部导航栏 -->
    <nav class="bottom-tabs">
        <a class="tab-item active" href="index.html">
            <span class="tab-icon tab-device"></span>
            <span>设备</span>
        </a>
        <a class="tab-item" href="discover.html">
            <span class="tab-icon tab-discover"></span>
            <span>发现</span>
        </a>
        <a class="tab-item" href="mine.html">
            <span class="tab-icon tab-mine"></span>
            <span>我的</span>
        </a>
    </nav>
    <script>
        // 1. 设置你的 OneNET 设备 ID
        const DEVICE_ID = '在这里填你的设备ID';

        // 2. HTML 元素与 OneNET 数据流 ID 的映射
        const STREAM_MAP = {
            'bat_tem': 'battery-temp', // 电池腔温度
            'Hum': 'battery-humidity', // 电池腔湿度
            'HFSensor': 'hf-sensor', // HF传感器
            'COSensor': 'co-sensor', // CO传感器
            'H2Sensor': 'h2-sensor', // H₂传感器
            'C2OSensor': 'c2o-sensor', // C₂O传感器
            'TVOC': 'tvoc-sensor', // TVOC传感器
            'PressureSensor': 'pressure-sensor' // 压力传感器
        };

        async function loadDeviceData() {
            if (!DEVICE_ID) {
                console.error('请先在脚本中配置 DEVICE_ID');
                return;
            }

            try {
                const resp = await fetch(`/api/onenet-proxy?device_id=${DEVICE_ID}`);
                const result = await resp.json();

                if (!result.success) {
                    console.error('OneNET 返回失败:', result.error);
                    return;
                }

                // OneNET 原始数据一般是 result.data.data.datastreams（注意两层 data）
                const root = result.data;
                const dsList = root && root.data && root.data.datastreams;
                if (!Array.isArray(dsList)) {
                    console.error('数据格式异常:', result);
                    return;
                }

                // 把数组转成 { id: 最新值 } 的形式
                const latest = {};
                dsList.forEach(stream => {
                    const id = stream.id;
                    const points = stream.datapoints || [];
                    if (points.length > 0) {
                        latest[id] = points[0].value;
                    }
                });

                // 根据 STREAM_MAP 更新页面
                Object.keys(STREAM_MAP).forEach(streamId => {
                    const elId = STREAM_MAP[streamId];
                    const el = document.getElementById(elId);
                    if (!el) return;

                    let value = latest[streamId];
                    if (value === undefined || value === null) {
                        el.textContent = '--' + (el.textContent.includes('kPa') ? ' kPa' : el.textContent.includes('ppm') ? ' ppm' : '');
                        return;
                    }

                    // 简单保留一位小数
                    if (typeof value === 'number') {
                        value = value.toFixed(1);
                    }

                    // 根据不同传感器拼接单位
                    if (['HFSensor', 'COSensor', 'H2Sensor', 'C2OSensor', 'TVOC'].includes(streamId)) {
                        el.textContent = `${value} ppm`;
                    } else if (streamId === 'PressureSensor') {
                        el.textContent = `${value} kPa`;
                    }
                });

            } catch (e) {
                console.error('请求 OneNET 失败:', e);
            }
        }

        // 页面加载完自动拉一次数据，之后每 30 秒刷新一次
        document.addEventListener('DOMContentLoaded', () => {
            loadDeviceData();
            setInterval(loadDeviceData, 30000);
        });
    </script>
</body>

</html>